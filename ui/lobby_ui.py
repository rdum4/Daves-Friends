"""
Providers the user interface for the lobby.
"""

from __future__ import annotations
from typing import TYPE_CHECKING
import asyncio

import discord.ui
from models.game_state import GameError
from services.lobby_service import LobbyService
from views.lobby_views import LobbyViews
from utils.utils import require_channel_id

from .interactions import Interactions

if TYPE_CHECKING:
    from views.renderer import Renderer


class LobbyUI(Interactions):
    """
    The user interface for the lobby, connecting the lobby views to Discord.
    """

    def __init__(
        self, renderer: Renderer, lobby_service: LobbyService, lobby_views: LobbyViews
    ):
        super().__init__()
        self._renderer = renderer
        self.lobby_service = lobby_service
        self.lobby_views = lobby_views

    @discord.ui.button(label="ðŸŒŸ Join", style=discord.ButtonStyle.blurple)
    async def join(
        self, interaction: discord.Interaction, _button: discord.ui.Button
    ) -> None:
        """
        The button for joining a lobby.
        """

        cid = require_channel_id(interaction)

        try:
            self.lobby_service.join_lobby(cid, interaction.user)
        except GameError as e:
            embed = self.lobby_views.error_embed(
                "Game Join" if e.title == "" else e.title, str(e)
            )
            await interaction.response.send_message(
                embeds=[embed],
                ephemeral=e.private,
            )
            return

        lobby = self.lobby_service.get_lobby(cid)
        await self._renderer.update_from_interaction(interaction, lobby)

    @discord.ui.button(label="ðŸš« Leave", style=discord.ButtonStyle.gray)
    async def leave(
        self, interaction: discord.Interaction, _button: discord.ui.Button
    ) -> None:
        """
        The button for leaving a lobby.
        """

        cid = require_channel_id(interaction)

        try:
            self.lobby_service.leave_lobby(cid, interaction.user)
        except GameError as e:
            embed = self.lobby_views.error_embed(
                "Leave" if e.title == "" else e.title, str(e), True
            )
            await interaction.response.send_message(
                embeds=[embed],
                ephemeral=e.private,
            )
            return

        lobby = self.lobby_service.get_lobby(cid)
        await self._renderer.update_from_interaction(interaction, lobby)

    @discord.ui.button(label="ðŸš€ Start Game", style=discord.ButtonStyle.success)
    async def start(
        self, interaction: discord.Interaction, _button: discord.ui.Button
    ) -> None:
        """
        The button for lobby creators to start the game.
        """

        cid = require_channel_id(interaction)

        try:
            lobby = self.lobby_service.get_lobby(cid)
            if interaction.user.id != lobby.user.id:
                raise GameError(
                    "You must be the host in order to start the game!",
                    private=True,
                    title="Must be host",
                )
            self.lobby_service.start_lobby(cid)
        except GameError as e:
            embed = self.lobby_views.error_embed(
                "Start" if e.title == "" else e.title, str(e), True
            )
            await interaction.response.send_message(
                embeds=[embed],
                ephemeral=e.private,
            )
            return

        await self._renderer.update_from_interaction(interaction, lobby)

        # Dm every player
        bot = interaction.client
        guild = interaction.guild.id
        for user_id in lobby.game.players():
            user = await bot.fetch_user(user_id)
            hand = lobby.game.hand(user_id)
            embed = self._renderer.hand_views.hand_embed(
                hand,
                optional_message=f"""This is your starting hand.
            \nLink to Game: https://discord.com/channels/{guild}/{cid}/{lobby.main_message}""",
            )

            await user.send(embed=embed)

        # Trigger AFK Timer
        cog = interaction.client.get_cog("UnoCog")
        if cog:
            asyncio.create_task(
                cog.run_afk_timer(
                    cid, lobby.game.current_player(), lobby.game.state["turn_count"]
                )
            )

    @discord.ui.button(label="ðŸš¨ Disband Game", style=discord.ButtonStyle.danger)
    async def disband(
        self, interaction: discord.Interaction, _button: discord.ui.Button
    ) -> None:
        """
        The button that disbands a lobby, preventing it from being started.
        """

        cid = require_channel_id(interaction)

        try:
            self.lobby_service.disband_lobby(cid, interaction.user)
        except GameError as e:
            embed = self.lobby_views.error_embed(
                "Must Be Host" if e.title == "" else e.title, str(e)
            )
            await interaction.response.send_message(embeds=[embed], ephemeral=e.private)
            return

        embed = self.lobby_views.update_embed(
            "Game Disbanded", "The host disbanded the game, so the lobby was deleted."
        )
        await interaction.response.send_message(embeds=[embed])
